<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCC ULS Database Search</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        .header { background: #2c3e50; color: white; padding: 30px 0; margin: -20px -20px 30px; }
        .header h1 { text-align: center; font-size: 2em; }
        .header p { text-align: center; margin-top: 10px; opacity: 0.9; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 12px 24px; background: white; border: 2px solid #3498db; color: #3498db; border-radius: 5px; cursor: pointer; font-weight: 600; }
        .tab.active { background: #3498db; color: white; }
        .search-box { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .search-type { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-type button { padding: 10px 20px; border: 2px solid #3498db; background: white; color: #3498db; border-radius: 5px; cursor: pointer; transition: all 0.3s; }
        .search-type button.active { background: #3498db; color: white; }
        .search-type button:hover { background: #2980b9; color: white; border-color: #2980b9; }
        .search-form { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        .search-form input, .search-form select { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; min-width: 200px; }
        .search-form button { padding: 12px 30px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .search-form button:hover { background: #229954; }
        .filter-options { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .checkbox-filter { display: flex; align-items: center; gap: 5px; }
        .checkbox-filter input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .checkbox-filter label { cursor: pointer; font-size: 14px; user-select: none; }
        .geographic-filters { display: none; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .geographic-filters.active { display: grid; }
        .results { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow-x: auto; }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #ecf0f1; flex-wrap: wrap; gap: 10px; }
        .results-count { color: #7f8c8d; }
        .results-controls { display: flex; gap: 10px; align-items: center; }
        .per-page-selector { display: flex; gap: 5px; align-items: center; }
        .per-page-selector label { font-size: 14px; color: #7f8c8d; }
        .per-page-selector select { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .export-btn { padding: 8px 16px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .export-btn:hover { background: #7f8c8d; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #ecf0f1; padding: 12px 8px; text-align: left; font-weight: 600; cursor: pointer; user-select: none; position: relative; }
        th:hover { background: #d5dbdb; }
        th.sortable::after { content: ' ‚áÖ'; opacity: 0.3; font-size: 12px; }
        th.sorted-asc::after { content: ' ‚Üë'; opacity: 1; color: #3498db; }
        th.sorted-desc::after { content: ' ‚Üì'; opacity: 1; color: #3498db; }
        td { padding: 12px 8px; border-bottom: 1px solid #ecf0f1; }
        tr:hover { background: #f8f9fa; }
        .pagination { display: flex; justify-content: center; gap: 5px; margin-top: 20px; flex-wrap: wrap; }
        .pagination button { padding: 8px 12px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 3px; }
        .pagination button:hover { background: #ecf0f1; }
        .pagination button.active { background: #3498db; color: white; border-color: #3498db; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
        .error { background: #e74c3c; color: white; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .badge { padding: 3px 8px; border-radius: 3px; font-size: 11px; font-weight: bold; display: inline-block; white-space: nowrap; }
        .badge-license { background: #3498db; color: white; }
        .badge-application { background: #9b59b6; color: white; }
        .status-badge { padding: 2px 8px; border-radius: 3px; font-size: 11px; font-weight: bold; white-space: nowrap; }
        .status-A { background: #27ae60; color: white; }
        .status-E { background: #e67e22; color: white; }
        .status-C { background: #e74c3c; color: white; }
        .status-P { background: #f39c12; color: white; }
        .status-G { background: #27ae60; color: white; }
        .status-D { background: #95a5a6; color: white; }
        .action-btn { padding: 4px 8px; margin: 2px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px; white-space: nowrap; }
        .action-btn:hover { background: #c0392b; }
        .export-note { font-size: 12px; color: #7f8c8d; margin-top: 5px; }
        @media (max-width: 768px) {
            .search-form { flex-direction: column; }
            .tabs { flex-direction: column; }
            table { font-size: 13px; }
            th, td { padding: 6px 4px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç FCC ULS Database Search</h1>
            <p>Search Licenses and Applications</p>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-category="license">üìã License Search</div>
            <div class="tab" data-category="application">üìù Application Search</div>
        </div>
        
        <div class="search-box" id="licenseSearch">
            <div class="search-type">
                <button class="active" data-type="callsign">Call Sign</button>
                <button data-type="frn">FRN</button>
                <button data-type="uls_id">ULS ID</button>
                <button data-type="name">Name</button>
                <button data-type="geographic">Geographic</button>
            </div>
            
            <form class="search-form" id="searchForm">
                <input type="text" id="searchInput" placeholder="Enter call sign..." required>
                <button type="submit">Search</button>
            </form>
            
            <div class="filter-options">
                <div class="checkbox-filter">
                    <input type="checkbox" id="activeOnlyCheckbox">
                    <label for="activeOnlyCheckbox">‚úì Active Licenses Only</label>
                </div>
            </div>
            
            <div class="geographic-filters" id="geoFilters">
                <select id="regionSelect">
                    <option value="">Select Region...</option>
                    <option value="northeast">Northeast</option>
                    <option value="southeast">Southeast</option>
                    <option value="midwest">Midwest</option>
                    <option value="southwest">Southwest</option>
                    <option value="west">West</option>
                </select>
                <select id="stateSelect">
                    <option value="">Select State...</option>
                </select>
                <input type="text" id="cityInput" placeholder="City...">
            </div>
        </div>
        
        <div class="search-box" id="applicationSearch" style="display: none;">
            <div class="search-type">
                <button class="active" data-type="application_file">File Number</button>
                <button data-type="application_status">Status</button>
                <button data-type="recent_applications">Recent Applications</button>
            </div>
            
            <form class="search-form" id="appSearchForm">
                <input type="text" id="appSearchInput" placeholder="Enter application file number..." required>
                <select id="appStatusSelect" style="display: none;">
                    <option value="">Select Status...</option>
                    <option value="P">Pending</option>
                    <option value="A">Accepted</option>
                    <option value="G">Granted</option>
                    <option value="D">Dismissed</option>
                    <option value="W">Withdrawn</option>
                    <option value="Q">Accepted in Part</option>
                    <option value="T">Terminated</option>
                </select>
                <button type="submit">Search</button>
            </form>
        </div>
        
        <div class="results" id="results" style="display: none;">
            <div class="results-header">
                <div class="results-count" id="resultsCount"></div>
                <div class="results-controls">
                    <div class="per-page-selector">
                        <label for="perPageSelect">Show:</label>
                        <select id="perPageSelect" onchange="changePerPage(this.value)">
                            <option value="25">25</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                            <option value="1000">1000</option>
                        </select>
                        <span style="font-size: 14px; color: #7f8c8d;">per page</span>
                    </div>
                    <button class="export-btn" id="exportBtn">Export to CSV</button>
                </div>
            </div>
            <div class="export-note">CSV exports limited to 50,000 records</div>
            <div id="resultsTable"></div>
            <div class="pagination" id="pagination"></div>
        </div>
        
        <div class="loading" id="loading" style="display: none;">‚è≥ Loading...</div>
    </div>
    
    <script>
        let currentCategory = 'license';
        let currentSearchType = 'callsign';
        let currentSearchParams = {};
        let currentPage = 1;
        let currentSortBy = 'call_sign';
        let currentSortOrder = 'asc';
        let currentPerPage = 50;
        let activeOnly = false;
        
        // Tab switching
        document.querySelectorAll('.tabs .tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentCategory = this.dataset.category;
                
                document.getElementById('licenseSearch').style.display = currentCategory === 'license' ? 'block' : 'none';
                document.getElementById('applicationSearch').style.display = currentCategory === 'application' ? 'block' : 'none';
                document.getElementById('results').style.display = 'none';
                
                if (currentCategory === 'application') {
                    currentSearchType = 'application_file';
                    currentSortBy = 'receipt_date';
                    currentSortOrder = 'desc';
                } else {
                    currentSearchType = 'callsign';
                    currentSortBy = 'call_sign';
                    currentSortOrder = 'asc';
                }
            });
        });
        
        // License search type buttons
        document.querySelectorAll('#licenseSearch .search-type button').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#licenseSearch .search-type button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentSearchType = this.dataset.type;
                updateSearchUI();
            });
        });
        
        // Application search type buttons
        document.querySelectorAll('#applicationSearch .search-type button').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#applicationSearch .search-type button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentSearchType = this.dataset.type;
                updateAppSearchUI();
            });
        });
        
        // Active only checkbox
        document.getElementById('activeOnlyCheckbox').addEventListener('change', function() {
            activeOnly = this.checked;
        });
        
        function updateSearchUI() {
            const input = document.getElementById('searchInput');
            const geoFilters = document.getElementById('geoFilters');
            
            if (currentSearchType === 'geographic') {
                input.style.display = 'none';
                input.required = false;
                geoFilters.classList.add('active');
                loadStates();
            } else {
                input.style.display = 'block';
                input.required = true;
                geoFilters.classList.remove('active');
                
                const placeholders = {
                    'callsign': 'Enter call sign...',
                    'frn': 'Enter FRN...',
                    'uls_id': 'Enter ULS System ID...',
                    'name': 'Enter first and/or last name...'
                };
                input.placeholder = placeholders[currentSearchType];
            }
        }
        
        function updateAppSearchUI() {
            const input = document.getElementById('appSearchInput');
            const statusSelect = document.getElementById('appStatusSelect');
            
            if (currentSearchType === 'application_status') {
                input.style.display = 'none';
                input.required = false;
                statusSelect.style.display = 'block';
                statusSelect.required = true;
            } else if (currentSearchType === 'recent_applications') {
                input.style.display = 'none';
                input.required = false;
                statusSelect.style.display = 'none';
                statusSelect.required = false;
            } else {
                input.style.display = 'block';
                input.required = true;
                statusSelect.style.display = 'none';
                statusSelect.required = false;
                input.placeholder = 'Enter application file number...';
            }
        }
        
        async function loadStates() {
            try {
                const response = await fetch('/api/regions');
                const data = await response.json();
                const select = document.getElementById('stateSelect');
                select.innerHTML = '<option value="">Select State...</option>';
                data.states.forEach(state => {
                    select.innerHTML += `<option value="${state}">${state}</option>`;
                });
            } catch (error) {
                console.error('Error loading states:', error);
            }
        }
        
        function changePerPage(value) {
            currentPerPage = parseInt(value);
            currentPage = 1;
            performSearch();
        }
        
        // License search form
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            currentPage = 1;
            await performSearch();
        });
        
        // Application search form
        document.getElementById('appSearchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            currentPage = 1;
            await performSearch();
        });
        
        async function performSearch() {
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            
            loading.style.display = 'block';
            results.style.display = 'none';
            
            // Build search parameters
            currentSearchParams = {
                type: currentSearchType,
                page: currentPage,
                per_page: currentPerPage,
                sort_by: currentSortBy,
                sort_order: currentSortOrder
            };
            
            if (currentCategory === 'license') {
                // Add active only filter
                currentSearchParams.active_only = activeOnly;
                
                if (currentSearchType === 'geographic') {
                    currentSearchParams.region = document.getElementById('regionSelect').value;
                    currentSearchParams.state = document.getElementById('stateSelect').value;
                    currentSearchParams.city = document.getElementById('cityInput').value;
                } else {
                    currentSearchParams.q = document.getElementById('searchInput').value;
                }
            } else {
                if (currentSearchType === 'application_status') {
                    currentSearchParams.q = document.getElementById('appStatusSelect').value;
                } else if (currentSearchType === 'recent_applications') {
                    currentSearchParams.q = '';
                } else {
                    currentSearchParams.q = document.getElementById('appSearchInput').value;
                }
            }
            
            try {
                const params = new URLSearchParams(currentSearchParams);
                const response = await fetch(`/api/search?${params}`);
                const data = await response.json();
                
                if (response.ok) {
                    displayResults(data);
                } else {
                    alert('Error: ' + (data.error || 'Search failed'));
                }
            } catch (error) {
                alert('Error performing search: ' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        }
        
        function sortBy(column) {
            if (currentSortBy === column) {
                // Toggle sort order
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortBy = column;
                currentSortOrder = 'asc';
            }
            currentPage = 1;
            performSearch();
        }
        
        function displayResults(data) {
            const results = document.getElementById('results');
            const resultsCount = document.getElementById('resultsCount');
            const resultsTable = document.getElementById('resultsTable');
            const pagination = document.getElementById('pagination');
            
            // Update per page selector
            document.getElementById('perPageSelect').value = data.per_page;
            
            let countText = `Found ${data.total.toLocaleString()} results`;
            if (data.active_only) {
                countText += ' (active only)';
            }
            countText += ` (showing ${data.results.length} on page ${data.page} of ${data.total_pages})`;
            resultsCount.textContent = countText;
            
            if (data.results.length === 0) {
                resultsTable.innerHTML = '<p>No results found</p>';
                pagination.innerHTML = '';
                results.style.display = 'block';
                return;
            }
            
            // Build table based on result type
            const isApplication = data.results[0].type === 'application';
            let html = '<table><thead><tr>';
            
            if (isApplication) {
                html += `<th class="sortable ${data.sort_by === 'uls_file_number' ? 'sorted-' + data.sort_order : ''}" onclick="sortBy('uls_file_number')">File Number</th>`;
                html += `<th class="sortable ${data.sort_by === 'call_sign' ? 'sorted-' + data.sort_order : ''}" onclick="sortBy('call_sign')">Call Sign</th>`;
                html += `<th class="sortable ${data.sort_by === 'application_purpose' ? 'sorted-' + data.sort_order : ''}" onclick="sortBy('application_purpose')">Purpose</th>`;
                html += `<th class="sortable ${data.sort_by === 'application_status' ? 'sorted-' + data.sort_order : ''}" onclick="sortBy('application_status')">Status</th>`;
                html += `<th class="sortable ${data.sort_by === 'receipt_date' ? 'sorted-' + data.sort_order : ''}" onclick="sortBy('receipt_date')">Receipt Date</th>`;
                html += `<th class="sortable ${data.sort_by === 'entity_name' ? 'sorted-' + data.sort_order : ''}" onclick="sortBy('entity_name')">Applicant</th>`;
                html += `<th class="sortable ${data.sort_by === 'frn' ? 'sorted-' + data.sort_order : ''}" onclick="sortBy('frn')">FRN</th>`;
            } else {
                html += `<th class="sortable ${data.sort_by === 'call_sign' ? 'sorted-' + data.sort_order : ''}" onclick="sortBy('call_sign')">Call Sign</th>`;
                html += `<th class="sortable ${data.sort_by === 'entity_name' ? 'sorted-' + data.sort_order : ''}" onclick="sortBy('entity_name')">Name</th>`;
                html += `<th class="sortable ${data.sort_by === 'frn' ? 'sorted-' + data.sort_order : ''}" onclick="sortBy('frn')">FRN</th>`;
                html += `<th class="sortable ${data.sort_by === 'unique_system_identifier' ? 'sorted-' + data.sort_order : ''}" onclick="sortBy('unique_system_identifier')">ULS ID</th>`;
                html += `<th class="sortable ${data.sort_by === 'license_status' ? 'sorted-' + data.sort_order : ''}" onclick="sortBy('license_status')">Status</th>`;
                html += `<th class="sortable ${data.sort_by === 'grant_date' ? 'sorted-' + data.sort_order : ''}" onclick="sortBy('grant_date')">Grant Date</th>`;
                html += `<th class="sortable ${data.sort_by === 'expired_date' ? 'sorted-' + data.sort_order : ''}" onclick="sortBy('expired_date')">Expiration</th>`;
                html += `<th class="sortable ${data.sort_by === 'state' ? 'sorted-' + data.sort_order : ''}" onclick="sortBy('state')">State</th>`;
                html += '<th>Actions</th>';
            }
            
            html += '</tr></thead><tbody>';
            
            data.results.forEach(row => {
                html += '<tr>';
                
                if (isApplication) {
                    const statusClass = `status-${row.application_status_code || 'P'}`;
                    html += `<td><strong>${row.uls_file_number || ''}</strong></td>`;
                    html += `<td>${row.call_sign || 'N/A'}</td>`;
                    html += `<td>${row.application_purpose || ''}</td>`;
                    html += `<td><span class="status-badge ${statusClass}">${row.application_status || ''}</span></td>`;
                    html += `<td>${row.receipt_date || ''}</td>`;
                    html += `<td>${row.entity_name || ''}</td>`;
                    html += `<td>${row.frn || ''}</td>`;
                } else {
                    const statusClass = `status-${row.license_status || 'U'}`;
                    html += `<td><strong>${row.call_sign || ''}</strong></td>`;
                    html += `<td>${row.entity_name || ''}</td>`;
                    html += `<td>${row.frn || ''}</td>`;
                    html += `<td>${row.unique_system_identifier || ''}</td>`;
                    html += `<td><span class="status-badge ${statusClass}">${row.license_status || ''}</span></td>`;
                    html += `<td>${row.grant_date || ''}</td>`;
                    html += `<td>${row.expired_date || ''}</td>`;
                    html += `<td>${row.state || ''}</td>`;
                    
                    // Add PDF download button for amateur radio licenses
                    if (row.radio_service_code === 'HA' && row.call_sign) {
                        html += `<td><button onclick="downloadLicensePDF('${row.call_sign}')" class="action-btn">üìÑ PDF</button></td>`;
                    } else {
                        html += `<td>-</td>`;
                    }
                }
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            resultsTable.innerHTML = html;
            
            // Build pagination
            let pageHtml = '';
            
            if (data.page > 1) {
                pageHtml += '<button onclick="changePage(1)">First</button>';
                pageHtml += `<button onclick="changePage(${data.page - 1})">Previous</button>`;
            }
            
            const maxPages = Math.min(data.total_pages, 10);
            const startPage = Math.max(1, data.page - 5);
            const endPage = Math.min(data.total_pages, startPage + 9);
            
            for (let i = startPage; i <= endPage; i++) {
                const active = i === data.page ? 'active' : '';
                pageHtml += `<button class="${active}" onclick="changePage(${i})">${i}</button>`;
            }
            
            if (data.page < data.total_pages) {
                pageHtml += `<button onclick="changePage(${data.page + 1})">Next</button>`;
                pageHtml += `<button onclick="changePage(${data.total_pages})">Last</button>`;
            }
            
            pagination.innerHTML = pageHtml;
            results.style.display = 'block';
        }
        
        function changePage(page) {
            currentPage = page;
            performSearch();
            window.scrollTo(0, 0);
        }
        
        function downloadLicensePDF(callsign) {
            window.location.href = `/api/license/${callsign}/pdf`;
        }
        
        // Export to CSV
        document.getElementById('exportBtn').addEventListener('click', async () => {
            const params = {...currentSearchParams};
            delete params.page;
            delete params.per_page;
            delete params.sort_by;
            delete params.sort_order;
            
            try {
                const response = await fetch('/api/export/csv', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(params)
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `uls_export_${new Date().getTime()}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Export failed');
                }
            } catch (error) {
                alert('Error exporting data: ' + error.message);
            }
        });
    </script>
</body>
</html>